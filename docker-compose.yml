services:
  # --- Microservices (Orchestrated by Tilt) ---

  messaging-service:
    image: messaging-service
    build:
      context: .
      dockerfile: microservices/messaging-service/Dockerfile
      target: dev
    container_name: messaging-service
    depends_on:
      kafka:
        condition: service_healthy
      cassandra:
        condition: service_healthy
    environment:
      - OTEL_SERVICE_NAME=messaging-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - PROMETHEUS_METRICS_PORT=${PROMETHEUS_METRICS_PORT}
      - APP_CASSANDRA_KEYSPACE=${APP_CASSANDRA_KEYSPACE}
      - APP_KAFKA_BROKERS=${APP_KAFKA_BROKERS}
      - APP_CASSANDRA_HOST=${APP_CASSANDRA_HOST}
      - APP_CASSANDRA_CONSISTENCY=${APP_CASSANDRA_CONSISTENCY}
    networks:
      - microservices-net

  social-service:
    image: social-service
    build:
      context: .
      dockerfile: microservices/social-service/Dockerfile
      target: dev
    container_name: social-service
    depends_on:
      kafka:
        condition: service_healthy
      neo4j:
        condition: service_healthy
    environment:
      - APP_NEO4J_URI=${APP_NEO4J_URI}
      - NEO4J_USER=${NEO4J_USER}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD}
      - APP_KAFKA_BROKERS=${APP_KAFKA_BROKERS}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=social-service
      - PROMETHEUS_METRICS_PORT=${PROMETHEUS_METRICS_PORT}
    networks:
      - microservices-net

  messaging-migration:
    image: messaging-migration
    build:
      context: .
      dockerfile: microservices/messaging-service/build/package/migrate/Dockerfile
    container_name: messaging-migration
    environment:
      - CASSANDRA_HOST=${APP_CASSANDRA_HOST}
      - APP_CASSANDRA_KEYSPACE=${APP_CASSANDRA_KEYSPACE}
    depends_on:
      cassandra:
        condition: service_healthy
    networks:
      - microservices-net

  notification-service:
    image: notification-service
    build:
      context: .
      dockerfile: microservices/notification-service/Dockerfile
      target: dev
    container_name: notification-service
    depends_on:
      kafka:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      - OTEL_SERVICE_NAME=notification-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - APP_KAFKA_BROKERS=${APP_KAFKA_BROKERS}
      - APP_REDIS_ADDR=${APP_REDIS_ADDR}
      - PROMETHEUS_METRICS_PORT=${PROMETHEUS_METRICS_PORT}
    networks:
      - microservices-net

  post-service:
    image: post-service
    build:
      context: .
      dockerfile: microservices/post-service/Dockerfile
      target: dev
    container_name: post-service
    depends_on:
      mongodb:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      - APP_MONGO_URI=${APP_MONGO_URI}
      - APP_KAFKA_BROKERS=${APP_KAFKA_BROKERS}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=post-service
      - PROMETHEUS_METRICS_PORT=${PROMETHEUS_METRICS_PORT}
    networks:
      - microservices-net

  auth-service:
    image: auth-service
    build:
      context: .
      dockerfile: microservices/auth/Dockerfile
      target: dev
    container_name: auth-service
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    environment:
      - APP_DB_DSN=${APP_DB_DSN}
      - APP_REDIS_ADDR=${APP_REDIS_ADDR}
      - APP_KAFKA_BROKERS=${APP_KAFKA_BROKERS}
      - APP_JWT_SECRET=${APP_JWT_SECRET}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=auth-service
      - PROMETHEUS_METRICS_PORT=${PROMETHEUS_METRICS_PORT}
    networks:
      - microservices-net

  gateway-service:
    image: gateway-service
    build:
      context: .
      dockerfile: microservices/gateway-service/Dockerfile
      target: dev
    container_name: gateway-service
    ports:
      - "8888:8888"
    depends_on:
      auth-service:
        condition: service_started
      post-service:
        condition: service_started
      kafka:
        condition: service_healthy
    environment:
      - APP_JWT_SECRET=${APP_JWT_SECRET}
      - POST_SERVICE=${POST_SERVICE_ADDR}
      - AUTH_SERVICE=${AUTH_SERVICE_ADDR}
      - KAFKA_BROKERS=${APP_KAFKA_BROKERS}
      - APP_REDIS_ADDR=${APP_REDIS_ADDR}
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_EXPORTER_OTLP_ENDPOINT}
      - OTEL_SERVICE_NAME=gateway-service
      - PROMETHEUS_METRICS_PORT=${PROMETHEUS_METRICS_PORT}
    networks:
      - microservices-net
    # --- Databases ---

    # Cassandra
  cassandra:
    image: cassandra:latest
    container_name: cassandra
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=MicroCluster
      - CASSANDRA_DC=datacenter1
      - CASSANDRA_RPC_ADDRESS=0.0.0.0
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - MAX_HEAP_SIZE=512M
      - LOCAL_JMX=no
      - JVM_EXTRA_OPTS=-Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false
    healthcheck:
      test: [ "CMD-SHELL", "nodetool status" ]
    volumes:
      - ./data/cassandra:/var/lib/cassandra
    networks:
      - microservices-net

  cassandra-exporter:
    image: criteord/cassandra_exporter:latest
    container_name: cassandra-exporter
    ports:

      - "9500:8080" # Maps to 9500 on host to avoid conflict with Kafka UI (8080).
    environment:
      - CASSANDRA_EXPORTER_CONFIG_host=cassandra:7199
      # - CASSANDRA_EXPORTER_CONFIG_user=user (if needed)
      # - CASSANDRA_EXPORTER_CONFIG_password=password (if needed)
      # command: [ "/cassandra_exporter-linux-amd64", "--cassandra.host", "cassandra" ] # REMOVED: Incorrect usage
    depends_on:
      cassandra:
        condition: service_healthy
    networks:
      - microservices-net

  # MongoDB
  mongodb:
    image: mongo:latest
    container_name: mongodb
    command: [ "mongod", "--quiet" ]
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ADMIN_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ADMIN_PASSWORD}
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - ./data/mongo:/data/db
    networks:
      - microservices-net

  mongodb-exporter:
    image: percona/mongodb_exporter:0.47.2
    container_name: mongodb-exporter
    command: [ "--mongodb.uri=mongodb://${MONGO_ADMIN_USER}:${MONGO_ADMIN_PASSWORD}@mongodb:27017" ]
    ports:
      - "9216:9216"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - microservices-net

  # Neo4j
  neo4j:
    image: neo4j:latest
    container_name: neo4j
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    environment:
      NEO4J_AUTH: ${NEO4J_USER}/${NEO4J_PASSWORD}
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:7474 || exit 1" ]
      interval: 10s
      timeout: 10s
      retries: 5

    volumes:
      - ./data/neo4j:/data
    networks:
      - microservices-net

  # Kafka (KRaft mode)
  kafka:
    image: confluentinc/cp-kafka:latest
    container_name: kafka
    hostname: kafka
    ports:
      - "9094:9094"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9094'
      KAFKA_PROCESS_ROLES: 'broker,controller'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: '1@kafka:29093'
      KAFKA_LISTENERS: 'PLAINTEXT://kafka:29092,CONTROLLER://kafka:29093,PLAINTEXT_HOST://0.0.0.0:9094'
      KAFKA_INTER_BROKER_LISTENER_NAME: 'PLAINTEXT'
      KAFKA_CONTROLLER_LISTENER_NAMES: 'CONTROLLER'
      KAFKA_LOG_DIRS: '/tmp/kraft-combined-logs'
      KAFKA_CLUSTER_ID: 'MkU3OEVBNTcwNTJDRkFCMz'
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9094" ]
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - microservices-net

  # Kafka UI
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      DYNAMIC_CONFIG_ENABLED: 'true'
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - microservices-net

  # Redis
  redis:
    image: redis:alpine
    container_name: redis
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - microservices-net

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: redis-exporter
    environment:
      - REDIS_ADDR=redis:6379
    ports:
      - "9121:9121"
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - microservices-net

  # Postgres
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U user -d auth_db" ]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./deploy/config/postgres-init.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - microservices-net

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter
    container_name: postgres-exporter
    ports:
      - "9187:9187"
    environment:
      DATA_SOURCE_NAME: ${APP_DB_DSN}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - microservices-net

  # --- GUI Tools ---

  # CloudBeaver (Postgres & Cassandra UI)
  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: cloudbeaver
    ports:
      - "8978:8978"
    environment:
      - CB_ADMIN_NAME=cbadmin
      - CB_ADMIN_PASSWORD=Password123!
    volumes:
      - ./data/cloudbeaver:/opt/cloudbeaver/workspace
    depends_on:
      postgres:
        condition: service_healthy
      cassandra:
        condition: service_healthy
    networks:
      - microservices-net

  # Redis Commander (Redis UI)
  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: redis-commander
    ports:
      - "8082:8081"
    environment:
      - REDIS_HOSTS=local:redis:6379
    networks:
      - microservices-net
    depends_on:
      redis:
        condition: service_healthy

  # Mongo Express (MongoDB UI)
  mongo-express:
    image: mongo-express:latest
    container_name: mongo-express
    ports:
      - "8081:8081"
    environment:
      - ME_CONFIG_MONGODB_SERVER=mongodb
      - ME_CONFIG_MONGODB_ADMINUSERNAME=admin
      - ME_CONFIG_MONGODB_ADMINPASSWORD=password
      - ME_CONFIG_BASICAUTH=false
    networks:
      - microservices-net
    depends_on:
      mongodb:
        condition: service_healthy

  # --- Observability Stack ---

  # MinIO (Unified Storage)
  minio:
    image: minio/minio
    container_name: minio
    command: [ "server", "/data", "--console-address", ":9001" ]
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - ./data/minio:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - microservices-net

  minio-setup:
    image: minio/mc
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c " until (/usr/bin/mc alias set local http://minio:9000 minioadmin minioadmin) do echo '...waiting for MinIO...' && sleep 1; done; /usr/bin/mc mb --ignore-existing local/loki-bucket; /usr/bin/mc mb --ignore-existing local/tempo-bucket; exit 0; "
    networks:
      - microservices-net

  # Loki (Logs Backend)
  loki:
    image: grafana/loki:latest
    container_name: loki
    user: "0:0"
    command: [ "-config.file=/etc/loki/local-config.yaml", "-log.level=warn" ]
    volumes:
      - ./deploy/config/loki.yaml:/etc/loki/local-config.yaml
      - ./data/loki:/tmp/loki
    ports:
      - "3100:3100"
    depends_on:
      minio:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    networks:
      - microservices-net

  # Tempo (Traces Backend)
  tempo:
    image: grafana/tempo:latest
    container_name: tempo
    user: "0:0"
    command: [ "--config.file=/etc/tempo.yaml" ]
    volumes:
      - ./deploy/config/tempo.yaml:/etc/tempo.yaml
      - ./data/tempo:/tmp/tempo
    ports:
      - "3200:3200"
      - "4317:4317" # OTLP grpc
    depends_on:
      minio:
        condition: service_healthy
      minio-setup:
        condition: service_completed_successfully
    networks:
      - microservices-net

  # Prometheus (Scraping + Metrics)
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./deploy/config/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9089:9090"
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
      - "--web.enable-remote-write-receiver"
      - "--web.enable-lifecycle"
    networks:
      - microservices-net
    depends_on:
      - cadvisor

  renderer-backend:
    image: grafana/grafana-image-renderer:latest
    container_name: renderer-backend
    environment:
      - ENABLE_METRICS=true
      # TIMEOUT ESTREMI (15+ MINUTI TOTALI)
      - RENDERING_TIMEOUT=900s # 15min TOTALE
      # BROWSER READINESS - LENTO MA COMPLETO
      - BROWSER_READINESS_TIMEOUT=600s # 10min per pagina "pronta"
      - BROWSER_READINESS_PRIOR_WAIT=5s # Pausa iniziale
      - BROWSER_READINESS_ITERATION_INTERVAL=200ms
      - BROWSER_READINESS_WAIT_FOR_N_QUERY_CYCLES=10 # StabilitÃ  estrema
      # NETWORK & QUERY - PIU' LENTI MA COMPLETE
      - BROWSER_READINESS_GIVE_UP_ON_FIRST_QUERY=600s
      - RENDERING_CLUSTERING_TIMEOUT=120s
      - BROWSER_READINESS_GIVE_UP_ON_ALL_QUERIES=300s # 5min query
      - BROWSER_READINESS_NETWORK_IDLE_TIMEOUT=120s # Network idl
      # SCROLL LENTO (fullPageImage)
      - BROWSER_TIME_BETWEEN_SCROLLS=200ms
      # CHROME FLAGS OTTIMIZZATI
      - BROWSER_FLAG=--no-sandbox
      - BROWSER_FLAG=--disable-dev-shm-usage
      - BROWSER_FLAG=--disable-gpu
      - BROWSER_FLAG=--disable-web-security
      - BROWSER_FLAG=--disable-features=VizDisplayCompositor
      # TIMEZONE
      - BROWSER_TIMEZONE=Europe/Rome
    volumes:
      - ./data/renderer-data:/data
    networks:
      - microservices-net
    # Internal backend doesn't need host exposure, but useful for debug on distinct port
    ports:
      - "8089:8081"

  # PROXY SERVICE (Named 'renderer' so Grafana hits THIS by default)
  # STRATEGY G Update: Now also acts as FRONT DOOR on port 3000
  renderer:
    image: nginx:alpine
    container_name: renderer-proxy
    ports:
      - "8084:8081" # Internal Proxy Debug
      - "3000:3000" # Front Door (Browser -> Nginx -> Grafana)
    volumes:
      - ./deploy/config/renderer_proxy_nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - renderer-backend
    networks:
      - microservices-net

  # Grafana (Visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SERVER_ROOT_URL=http://localhost:3000/
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=password
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin # Temporarily elevated for Renderer access
      - GF_ALERTING_ENABLED=false
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_LOG_LEVEL=warn
      - GF_ALERTING_ENABLED=true
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_UNIFIED_ALERTING_ENABLED=true
      - GF_RENDERING_SERVER_URL=http://renderer:8081/render
      # STRATEGY C: 600s WITH UNITS EVERYWHERE
      - GF_RENDERING_SERVER_TIMEOUT=600s
      - GF_RENDERING_TIMEOUT=600s
      - GF_RENDERING_REQUEST_TIMEOUT=600s
      # STRATEGY D: ALERTING TIMEOUT (Max 30s allowed)
      - GF_UNIFIED_ALERTING_SCREENSHOTS_CAPTURE_TIMEOUT=30s
      - GF_RENDERING_CALLBACK_URL=http://grafana:3000/
      # HTTP & Proxy (Must match or exceed render timeout)
      - GF_DATAPROXY_TIMEOUT=600s
      - GF_HTTP_REQUEST_MAX_TIMEOUT=600s
    # Strategy G: Front-Door Proxy takes port 3000. Grafana stays internal.
    # ports:
    #   - "3000:3000"
    volumes:
      - ./deploy/config/grafana/provisioning:/etc/grafana/provisioning
      - ./deploy/config/grafana/dashboards:/var/lib/grafana/dashboards
      - ./deploy/config/grafana/grafana.ini:/etc/grafana/grafana.ini
    networks:
      - microservices-net
    depends_on:
      loki:
        condition: service_started
      tempo:
        condition: service_started
      prometheus:
        condition: service_started
      renderer:
        condition: service_started

  # Alloy (Collector)
  alloy:
    image: grafana/alloy:latest
    container_name: alloy
    command: [ "run", "--server.http.listen-addr=0.0.0.0:12345", "/etc/alloy/config.alloy" ]
    volumes:
      - ./deploy/config/alloy.config:/etc/alloy/config.alloy
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      tempo:
        condition: service_started
      prometheus:
        condition: service_started
      loki:
        condition: service_started
    ports:
      - "12345:12345"
      - "4318:4318" # OTLP HTTP
    networks:
      - microservices-net

  # Pyroscope
  pyroscope:
    image: grafana/pyroscope:latest
    container_name: pyroscope
    ports:
      - "4040:4040"
    networks:
      - microservices-net

  # cAdvisor
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8083:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
      - /dev:/dev:ro
    networks:
      - microservices-net

  # K6 (Load Testing)
  k6:
    image: grafana/k6:latest
    container_name: k6
    volumes:
      - ./test/k6:/scripts
    ports:
      - "6565:6565" # K6 REST API
    networks:
      - microservices-net
    profiles: [ "tools" ]

networks:
  microservices-net:


