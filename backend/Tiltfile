# Tiltfile

# --- Docker Compose ---
docker_compose('docker-compose.yml')

# --- Infrastructure ---
# --- Infrastructure ---
dc_resource('cassandra', labels=['Infrastructure'])
dc_resource('mongodb', labels=['Infrastructure'])
dc_resource('neo4j', labels=['Infrastructure'])
dc_resource('redis', labels=['Infrastructure'])
dc_resource('kafka', labels=['Infrastructure'])
dc_resource('postgres', labels=['Infrastructure'])
dc_resource('meilisearch', labels=['Infrastructure'])

# --- Tooling (GUIs) ---
dc_resource('kafka-ui', labels=['Tooling'], links=[link('http://localhost:8080', 'Kafka UI')])
dc_resource('cloudbeaver', labels=['Tooling'], links=[link('http://localhost:8978', 'CloudBeaver')])
dc_resource('redis-commander', labels=['Tooling'], links=[link('http://localhost:8082', 'Redis Commander')])
dc_resource('mongo-express', labels=['Tooling'], links=[link('http://localhost:8081', 'Mongo Express')])

# Manual K6 Trigger
local_resource(
    'run-load-test',
    cmd='docker compose run --rm k6 run /scripts/load.js',
    labels=['Tooling'],
    trigger_mode=TRIGGER_MODE_MANUAL,
    auto_init=False,
)

# --- Observability Stack ---
dc_resource('minio', labels=['Observability'], links=[link('http://localhost:9001', 'MinIO Console')])
dc_resource('grafana', labels=['Observability'], links=[link('http://localhost:3000', 'Grafana')])
dc_resource('prometheus', labels=['Observability'], links=[link('http://localhost:9089', 'Prometheus')])
dc_resource('tempo', labels=['Observability']) # Headless
dc_resource('loki', labels=['Observability']) # Headless
dc_resource('pyroscope', labels=['Observability'], links=[link('http://localhost:4040', 'Pyroscope')])
dc_resource('alloy', labels=['Observability'])
dc_resource('minio-setup', labels=['Observability'])
dc_resource('cadvisor', labels=['Observability'])
dc_resource('renderer', labels=['Observability'], links=[link('http://localhost:3000', 'Renderer Proxy')])
dc_resource('renderer-backend', labels=['Observability'])


# --- Exporters ---
dc_resource('postgres-exporter', labels=['Exporters'])
dc_resource('cassandra-exporter', labels=['Exporters'])
dc_resource('mongodb-exporter', labels=['Exporters'])
dc_resource('redis-exporter', labels=['Exporters'])


# --- Microservices ---



# Auth Service
docker_build(
    'auth-service',
    '.',
    dockerfile='microservices/auth/Dockerfile',
    live_update=[
        sync('./microservices/auth', '/app'),
        sync('./shared', '/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('auth-service', labels=['Microservices'])


# Gateway Service
docker_build(
    'gateway-service',
    '.',
    dockerfile='microservices/gateway-service/Dockerfile',
    live_update=[
        sync('./microservices/gateway-service', '/app'),
        sync('./shared', '/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('gateway-service', labels=['Microservices'])


# Post Service
docker_build(
    'post-service',
    '.',
    dockerfile='microservices/post-service/Dockerfile',
    live_update=[
        sync('./microservices/post-service', '/app'),
        sync('./shared', '/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('post-service', labels=['Microservices'])


# Migration Tool (Automatic)
# Runs on startup to initialize Cassandra schema.
docker_build(
    'messaging-migration',
    '.',
    dockerfile='microservices/messaging-service/build/package/migrate/Dockerfile',
)
dc_resource(
    'messaging-migration',
    labels=['Tooling'],
    # Removed manual trigger for auto-start
)


# messaging-service
docker_build(
    'messaging-service',
    '.',
    dockerfile='microservices/messaging-service/Dockerfile',
    live_update=[
        sync('./microservices/messaging-service', '/app/microservices/messaging-service'),
        sync('./shared', '/app/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('messaging-service', labels=['Microservices'])

# Social Service
docker_build(
    'social-service',
    '.',
    dockerfile='microservices/social-service/Dockerfile',
    live_update=[
        sync('./microservices/social-service', '/app/microservices/social-service'),
        sync('./shared', '/app/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('social-service', labels=['Microservices'])
# notification-service
docker_build(
    'notification-service',
    '.',
    dockerfile='microservices/notification-service/Dockerfile',
    live_update=[
        sync('./microservices/notification-service', '/app/microservices/notification-service'),
        sync('./shared', '/app/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('notification-service', labels=['Microservices'])
# search-service
docker_build(
    'search-service',
    '.',
    dockerfile='microservices/search-service/Dockerfile',
    live_update=[
        sync('./microservices/search-service', '/app/microservices/search-service'),
        sync('./shared', '/app/shared'),
        run('go build -o /server .'),
        restart_container()
    ]
)
dc_resource('search-service', labels=['Microservices'])